<!DOCTYPE html>
<html>
  <head>
    <title>MEJ Colorado</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,600,700|Open+Sans:300,400,600" rel="stylesheet">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700' rel='stylesheet' type='text/css'>
    <!-- Include jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <!-- Include Leaflet -->
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"></script>
    <link href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" rel="stylesheet">
    <!-- Include CARTO.js -->
    <script src="https://libs.cartocdn.com/carto.js/v4.0.8/carto.min.js"></script>
    <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v1.0.0/mapbox-gl.css" rel="stylesheet">
    <!--Geocoder-->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <!-- Adding Axios -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.min.js"></script>

    <style type="text/css">
      html,
      body {
        height: 100%;
        padding: 0;
        margin: 0;
        position: relative;
      }
      #map {
        height: 100%;
        padding: 0;
        margin: 0;
      }
      #wrapper-dropdown-selector {
        position: absolute;
        top: 15px;
        right: 10px;
        z-index: 999;
      }
      #js-dropdown-selector {
        width: 160px;
        font-size: 16px;
        padding: 6px;
        margin-bottom: 0;
        color: #333;
        background-color: #fff;
        border: 0px;
        /* border-color: #ccc; */
        /* border: 1px solid rgb(127, 0, 0);
        border: 1px solid rgba(255, 0, 0, .5);
        -webkit-background-clip: padding-box;
        background-clip: padding-box; */
        border-radius: 3px;
        box-shadow: 0px 0px 0px 2px rgba(0,0,0,0.3);
        white-space: nowrap;
      }
      #js-dropdown-selector:hover {
        color: #333;
        background-color: #e6e6e6;
        /* border-color: #adadad; */
      }
      #js-dropdown-selector:active:focus {
          outline: thin dotted;
          outline: 5px auto -webkit-focus-ring-color;
          outline-offset: -2px;
      }
      #js-dropdown-selector:focus {
        color: #333;
        background-color: #e6e6e6;
      }
      #js-dropdown-selector:active {
        box-shadow: inset 0 3px 5px rgba(0,0,0,.125);
        color: #333;
        background-color: #e6e6e6;
      }
      .legend {
        line-height: 18px;
        color: #555;
      }
      .legend i {
        width: 18px;
        height: 18px;
        float: left;
        margin-right: 8px;
        opacity: 0.7;
      }
      .info {
        padding: 6px 8px;
        font: 14px/16px Arial, Helvetica, sans-serif;
        background: white;
        background: rgba(255,255,255,0.8);
        box-shadow: 0 0 15px rgba(0,0,0,0.2);
        border-radius: 5px;
      }
      .info h4 {
        /* margin: 0 0 5px; */
        color: #777;
      }
      .popup-list li:not(:last-child){
        margin-bottom: -15px;
      }
    </style>
  </head>

  <body>
    <div id="map"></div>

    <!-- dropdown selector-->
    <div id="wrapper-dropdown-selector">
      <select id="js-dropdown-selector">
      </select>
    </div>

    <script>
      const map = L.map('map').setView([39.019715, -105.765333], 7); // set to focus on CO
      // map.scrollWheelZoom.disable();

      //basemap
      L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}.png', {
        maxZoom: 18
      }).addTo(map);

      // Adding Voyager Labels
      L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_only_labels/{z}/{x}/{y}.png', {
        maxZoom: 18,
        zIndex: 10
      }).addTo(map);

      const client = new carto.Client({
        apiKey: 'default_public',
        username: 'tiffanyhuynh'
      });

      // const query = 'SELECT * FROM colorado_sample';
      // const source = new carto.source.SQL(query);
      const source = new carto.source.Dataset('colorado_final');
      const layerStyle = new carto.style.CartoCSS(`
        #layer {
          polygon-fill: ramp([finalscore], (#009392, #39b185, #9ccb86, #e9e29c, #eeb479, #e88471, #cf597e), quantiles(7));
            ::outline {
              line-width: 0.5;
              line-color: #FFFFFF;
              line-opacity: 0.5;
            }
        }
      `);

      const layer = new carto.layer.Layer(source, layerStyle, {
        featureOverColumns: ['cartodb_id', 'name',
         'fips_tract',
         'lead_score',
         'total_pop',
         'poverty_sc',
         'edu_score',
         'lin_score',
         'unemploy_s',
         'nonwhitepe',
         'houseburde',
         'ozone_scor',
         'diesel_sco',
         'oil_score',
         'oil_densit',
         'toxics_sco',
         'pm25_score',
         'avg_ptraf',
         'avg_ptsdf',
         'avg_prmp',
         'avg_pwdis',
         'avg_pnpl',
         'asthma_sco',
         'lb_score',
         'hd_score',
         'demographi',
         'exposure_s',
         'effects_sc',
         'sensitive_',
         'pollution_',
         'pop_char',
         'finalscore']
      });

      client.addLayer(layer);
      client.getLeafletLayer().addTo(map);

      // Geocoder
      // L.Control.geocoder({position: 'topleft'}).addTo(map);

/////////////////////////// dictionary + JSON objects for indicators data ///////////////////////////////

      //also: Carto automatically truncates column names to 10 letters or less...
      //form: dictionary = key as column title, value as JSON object with the categories: official display name, column title, choropleth colors, and number of quantiles for ramp
      //later can also add to the JSON objects text explanations of each indicator, links to reference more info, icons/images to display with the indicator, etc.
      ind_dict = {'finalscore': {"indicator_name" : "Final score", "indicator_col" : "finalscore", "choropleth_colors":["#009392", "#39b185", "#9ccb86", "#e9e29c", "#eeb479", "#e88471", "#cf597e"], "num_quantiles": 7},
      'total_pop': {"indicator_name" : "Total population", "indicator_col" : "total_pop", "choropleth_colors":[['#c4e6c3','#96d2a4','#6dbc90','#4da284','#36877a','#266b6e','#1d4f60']], "num_quantiles": 7},
      'pop_char': {"indicator_name" : "Population Characteristics", "indicator_col" : "pop_char", "choropleth_colors":['#f2f0f7', '#dadaeb', '#bcbddc', '#9e9ac8', '#807dba', '#6a51a3', '#4a1486'], "num_quantiles": 7},
      'pollution_': {"indicator_name" : "Pollution Score", "indicator_col" : "pollution_", "choropleth_colors":['#3288bd', '#99d594', '#e6f598', '#ffffbf', '#fee08b', '#fc8d59', '#d53e4f'], "num_quantiles": 7},
      'demographi': {"indicator_name" : "Demographics Score", "indicator_col" : "demographi", "choropleth_colors":['#eff3ff', '#c6dbef', '#9ecae1', '#6baed6', '#4292c6', '#2171b5', '#084594'], "num_quantiles": 7},
      'sensitive_': {"indicator_name" : "Sensitive Score", "indicator_col" : "sensitive_", "choropleth_colors":['#b0f2bc', '#89e8ac', '#67dba5', '#4cc8a3', '#38b2a3', '#2c98a0', '#257d98'], "num_quantiles": 7},
      'exposure_s': {"indicator_name" : "Exposure Score", "indicator_col" : "exposure_s", "choropleth_colors":['#894f94', '#af8dc3', '#e7d4e8', '#f7f7f7', '#d9f0d3', '#7fbf7b', '#1b7837'], "num_quantiles": 7},
      'effects_sc': {"indicator_name" : "Effects Score", "indicator_col" : "effects_sc", "choropleth_colors":['#1a9850', '#91cf60', '#d9ef8b', '#ffffbf', '#fee08b', '#fc8d59', '#d73027'], "num_quantiles": 7},
      'lead_score': {"indicator_name" : "Lead Exposure", "indicator_col" : "lead_score", "choropleth_colors":["#fef6b5","#ffdd9a","#ffc285","#ffa679","#fa8a76","#f16d7a","#e15383"], "num_quantiles": 7},
      'poverty_sc': {"indicator_name" : "Poverty", "indicator_col" : "poverty_sc", "choropleth_colors":['#fde0c5','#facba6','#f8b58b','#f59e72','#f2855d','#ef6a4c','#eb4a40'], "num_quantiles": 7},
      'edu_score': {"indicator_name" : "Educational Attainment", "indicator_col" : "edu_score", "choropleth_colors":['#e4f1e1','#b4d9cc','#89c0b6','#63a6a0','#448c8a','#287274','#0d585f'], "num_quantiles": 7},
      'lin_score': {"indicator_name" : "Linguistic Isolation", "indicator_col" : "lin_score", "choropleth_colors":['#f3cbd3','#eaa9bd','#dd88ac','#ca699d','#b14d8e','#91357d','#6c2167'], "num_quantiles": 7},
      'unemploy_s': {"indicator_name" : "Unemployment", "indicator_col" : "unemploy_s", "choropleth_colors":['#ede5cf','#e0c2a2','#d39c83','#c1766f','#a65461','#813753','#541f3f'], "num_quantiles": 7},
      'nonwhitepe': {"indicator_name" : "Race", "indicator_col" : "nonwhitepe", "choropleth_colors":["#f3e0f7", "#e4c7f1", "#d1afe8", "#b998dd", "#9f82ce", "#826dba", "#63589f"], "num_quantiles": 7},
      'houseburde': {"indicator_name" : "Housing Burden", "indicator_col" : "houseburde", "choropleth_colors":['#008080','#70a494','#b4c8a8','#f6edbd','#edbb8a','#de8a5a','#ca562c'], "num_quantiles": 7},
      'ozone_scor': {"indicator_name" : "Ozone", "indicator_col" : "ozone_scor", "choropleth_colors":['#009B9E','#42B7B9','#A7D3D4','#F1F1F1','#E4C1D9','#D691C1','#C75DAB'], "num_quantiles": 7},
      'diesel_sco': {"indicator_name" : "DieselPM", "indicator_col" : "diesel_sco", "choropleth_colors":['#798234','#a3ad62','#d0d3a2','#fdfbe4','#f0c6c3','#df91a3','#d46780'], "num_quantiles": 7},
      'oil_score': {"indicator_name" : "Oil Counts", "indicator_col" : "oil_score", "choropleth_colors":['#798234','#a3ad62','#d0d3a2','#fdfbe4','#f0c6c3','#df91a3','#d46780'], "num_quantiles": 7},
      'oil_densit': {"indicator_name" : "Oil Density", "indicator_col" : "oil_densit", "choropleth_colors":['#798234','#a3ad62','#d0d3a2','#fdfbe4','#f0c6c3','#df91a3','#d46780'], "num_quantiles": 7},
      'toxics_sco': {"indicator_name" : "Toxic Releases", "indicator_col" : "toxics_sco", "choropleth_colors":['#fbe6c5','#f5ba98','#ee8a82','#dc7176','#c8586c','#9c3f5d','#70284a'], "num_quantiles": 7},
      'pm25_score': {"indicator_name" : "PM2.5", "indicator_col" : "pm25_score", "choropleth_colors":['#3d5941','#778868','#b5b991','#f6edbd','#edbb8a','#de8a5a','#ca562c'], "num_quantiles": 7},
      'avg_ptraf': {"indicator_name" : "Traffic Exposure", "indicator_col" : "avg_ptraf", "choropleth_colors":['#009392','#72aaa1','#b1c7b3','#f1eac8','#e5b9ad','#d98994','#d0587e'], "num_quantiles": 7},
      'avg_ptsdf': {"indicator_name" : "Hazardous Waste Facilities", "indicator_col" : "avg_ptsdf", "choropleth_colors":['#f6d2a9','#f5b78e','#f19c7c','#ea8171','#dd686c','#ca5268','#b13f64'], "num_quantiles": 7},
      'avg_prmp': {"indicator_name" : "High-Risk Chemical Facilities", "indicator_col" : "avg_prmp", "choropleth_colors":['#ecda9a','#efc47e','#f3ad6a','#f7945d','#f97b57','#f66356','#ee4d5a'], "num_quantiles": 7},
      'avg_pwdis': {"indicator_name" : "Wastewater Discharges", "indicator_col" : "avg_pwdis", "choropleth_colors":['#d1eeea','#a8dbd9','#85c4c9','#68abb8','#4f90a6','#3b738f','#2a5674'], "num_quantiles": 7},
      'avg_pnpl': {"indicator_name" : "Superfund Sites", "indicator_col" : "avg_pnpl", "choropleth_colors":['#fcde9c','#faa476','#f0746e','#e34f6f','#dc3977','#b9257a','#7c1d6f'], "num_quantiles": 7},
      'asthma_sco': {"indicator_name" : "Asthma", "indicator_col" : "asthma_sco", "choropleth_colors":['#ffffb2', '#fed976', '#feb24c', '#fd8d3c', '#fc4e2a', '#e31a1c', '#b10026'], "num_quantiles": 7},
      'lb_score': {"indicator_name" : "Low Birth-Weight Infants", "indicator_col" : "lb_score", "choropleth_colors":['#d2fbd4', '#a5dbc2', '#7bbcb0', '#559c9e', '#3a7c89', '#235d72', '#123f5a'], "num_quantiles": 7},
      'hd_score': {"indicator_name" : "Cardiovascular Disease", "indicator_col" : "hd_score", "choropleth_colors":['#ffffd4', '#fee391', '#fec44f', '#fe9929', '#ec7014', '#cc4c02', '#8c2d04'], "num_quantiles": 7}};

/////////////////////////// highlight tract borders when hover over/clicked ///////////////////////////////


      var polygon;
      function showFeature(featureEvent) {
        polygon_selected = featureEvent.data.cartodb_id;
        console.log("polygon selected");
        console.log(polygon_selected);
        const boundsQuery = `SELECT ST_asGeoJSON(ST_Boundary(the_geom)) as geom FROM colorado_final WHERE cartodb_id = ${polygon_selected}`;
        const boundsUrl = `https://tiffanyhuynh.carto.com/api/v2/sql?q=${boundsQuery}&api_key=default_public`

        fetch(boundsUrl)
          .then(response => {
              return response.json();
            })
            .then(json => {
              if (polygon) {
                console.log('remove polygon');
                console.log(polygon);
                map.removeLayer(polygon);
              }
              polygon = L.geoJson(JSON.parse(json.rows[0].geom), {
                style: {
                  color: "#fff",
                  fillColor: "#fff",
                  weight: 2,
                  opacity: 0.65
                }
              })
            // .addTo(map);
            map.addLayer(polygon);
            });
      };

      function resetHighlight(featureEvent) {
        console.log("did reset?");
        // map.removeLayer(polygon);
        client.removeLayer(polygon)
        .then(() => {
         console.log('Layer removed');
        })
        .catch(cartoError => {
         console.error(cartoError.message);
        });
      }

      // layer.on('mouseover', showFeature);
      // layer.on('mouseout', function (e) {
      //     this.closePopup();
      // });
      //next: code to remove clicked polygon highlight when popup closes and go back to hover highlight
      //next: code to keep clicked polygon highlight and stop hover highlight when click
      //maybe a second parameter?

      // layer.on('featureClicked', showFeature);

      layer.on('featureOut', resetHighlight);
      layer.on('featureOver', showFeature);

      //on featureClick, layer.off('featureOver')

      //this method seems to be too glitchy: featureOver is slow...


/////////////////////////// populate dropdown using JSON data ///////////////////////////////


      window.onload = function() {
        replace_dropdown();
      }

      function replace_dropdown() {
        var dropdown_html = `<option value="finalscore" selected>Final score</option>`; //code apart from others because want this to be default selected
        for (var key in ind_dict) {
          var get_value = ind_dict[key];
          if (key != 'finalscore') {
            dropdown_html += `<option value="${key}">${get_value.indicator_name}</option>`;
          }
        }
        document.getElementById("js-dropdown-selector").innerHTML = dropdown_html;
        console.log(document.getElementById("wrapper-dropdown-selector").innerHTML);
      }

/////////////////////////// change layers on dropdown select using JSON data ////////////////////////

      //change content styling with dropdown values
      $("#js-dropdown-selector").on('change', function(e) {
        console.log('hi');
        let value = e.target.value;
        console.log(value);
        var returned_value = ind_dict[value];
        //don't need to fix for null values because in turbo-carto, null gets the low value from the ramp.
        //which means the oil and gas nulls which are really 0 values get rendered as so--thank you Carto <3
        layerStyle.setContent(`
          #layer {
            polygon-fill: ramp([${returned_value.indicator_col}], (${returned_value.choropleth_colors}), quantiles(${returned_value.num_quantiles}));
              ::outline {
                line-width: 0.5;
                line-color: #FFFFFF;
                line-opacity: 0.5;
              }
          }`)
         .then(() => {
           console.log('cartoCSS was updated');
         })
         .catch(() => {
           console.error('Error updating the cartoCSS for the layer');
         });
      });

/////////////////////////// popups using indicator JSON ///////////////////////////////

    // create popups
    const popup = L.popup({closeButton: true, maxHeight: 200});

    function openPopup(featureEvent) {
      let content = '<div class="widget">';
      console.log('hello');
      console.log(featureEvent);
      console.log(featureEvent.data);
      console.log('try dis');
      console.log(featureEvent.data.avg_pnpl);

      //need to write FIPS tract id first
      content += `<h4 class="open-sans">Census tract: ${featureEvent.data.fips_tract}</h4>`;

      content += '<ul class="popup-list" style="list-style-type:none; padding-left:0">';
      //iterate through all in featureEvent.data
      for (var key in ind_dict) {
        //need way to exclude ranks?? or include them later with formatting
        if ((key != 'cartodb_id') && (!key.includes("rank")) && (key != 'fips_tract') && (key !='name')) {
            var actual_name = ind_dict[key];
            console.log(key);
            console.log(actual_name);
            if (featureEvent.data[key] == null) {
              if ((key == 'oil_score')||(key == 'oil_densit')) {
                content += `<li><p><b>${actual_name.indicator_name}:</b> 0</p></li>`;
              } else {
                content += `<li><p><b>${actual_name.indicator_name}:</b> N/A</p></li>`;
              }
            } else {
              content += `<li><p><b>${actual_name.indicator_name}:</b> ${featureEvent.data[key].toFixed(2)}</p></li>`;
            }
        }
      }
      content += '</ul>';
      popup.setContent(content);
      popup.setLatLng(featureEvent.latLng);
      if (!popup.isOpen()) {
        popup.openOn(map);
      }
    }

    //click-on popup (can change to hover too)
    layer.off('featureOut');
    layer.on('featureClicked', openPopup);


///////////////////////////// add/change legend ///////////////////////////////

      var legend  = L.control({position: 'bottomright'})

      layer.on('metadataChanged', function(event){

        // console.log(event.styles[0]._buckets); //print array of buckets

        console.log('checkingg');
        console.log(event.styles[0]._column);

        // get buckets
        var buckets = event.styles[0]._buckets;
        //each Bucket has props: min, max, and value (which here is the color string code)

        legend.onAdd = function (map) {
          var div = L.DomUtil.create('div', 'info legend');
          var column = event.styles[0]._column;
          if ((column == 'oil_densit') || (column == 'oil_score')) {
            div.innerHTML +=
                `<ul style="list-style-type:none; padding-left:0"><i style="background: ${buckets[0].value}"></i> <span>0 - ${parseFloat(buckets[0].max).toFixed(2)}</span></ul>`;
            for (var i = 1; i < 7; i++) {
              div.innerHTML +=
                `<ul style="list-style-type:none; padding-left:0"><i style="background: ${buckets[i].value}"></i> <span>${parseFloat(buckets[i].min).toFixed(2)} - ${parseFloat(buckets[i].max).toFixed(2)}</span></ul>`;
            }
          } else {
            // wrote this for 7 quantiles, need to change if we vary quantiles for different indicators
            for (var i = 0; i < 7; i++) {
              div.innerHTML +=
                `<ul style="list-style-type:none; padding-left:0"><i style="background: ${buckets[i].value}"></i> <span>${parseFloat(buckets[i].min).toFixed(2)} - ${parseFloat(buckets[i].max).toFixed(2)}</span></ul>`;
            }
          }
          return div;
        };
        legend.addTo(map);
      });
  </script>
  </body>
</html>

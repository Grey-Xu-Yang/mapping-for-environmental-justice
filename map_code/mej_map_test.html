<!DOCTYPE html>
<html>
  <head>
    <title>MEJ Colorado</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,600,700|Open+Sans:300,400,600" rel="stylesheet">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" type="text/css">
    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
    <!-- Bootstrap -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.4/css/bootstrap-select.min.css">
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.4/js/bootstrap-select.min.js"></script>
    <!-- (Optional) Latest compiled and minified JavaScript translation files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.4/js/i18n/defaults-en_US.js"></script>
    <!-- Include Leaflet -->
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"></script>
    <link href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" rel="stylesheet">
    <!-- Include CARTO.js -->
    <script src="https://libs.cartocdn.com/carto.js/v4.0.8/carto.min.js"></script>
    <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v1.0.0/mapbox-gl.css" rel="stylesheet">
    <!--Geocoder-->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <!-- Adding Axios -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.min.js"></script>

    <!-- css grouped by feature -->
    <style type="text/css">
      html,
      body {
        height: 100%;
        padding: 0;
        margin: 0;
        position: relative;
      }
      #map {
        height: 100%;
        padding: 0;
        margin: 0;
      }
      /* zoom bar */
      .leaflet-bar a {
        background-color: #fff;
        border-bottom: 1px solid #ccc;
        color: #444;
        display: block;
        height: 26px;
        width: 26px;
        line-height: 1.45 !important;
        text-align: center;
        text-decoration: none;
        font: bold 18px 'Lucida Console', Monaco, monospace;
      }
      /* dropdown */
      #wrapper-dropdown-selector {
        position: absolute;
        top: 15px;
        right: 10px;
        z-index: 10000000;
      }
      .btn-dropdown {
        width: 160px;
        font-size: 16px;
        padding: 6px;
        margin-bottom: 0;
        color: #333;
        background-color: #fff;
        border: 0px;
        border-radius: 3px;
        box-shadow: 0px 0px 0px 2px rgba(0,0,0,0.3);
        white-space: nowrap;
        z-index: 100000;
      }
      .btn-dropdown:hover {
        color: #333;
        background-color: #e6e6e6;
      }
      .btn-dropdown:active:focus {
          outline: thin dotted;
          outline: 5px auto -webkit-focus-ring-color;
          outline-offset: -2px;
      }
      .btn-dropdown:focus {
        color: #333;
        background-color: #e6e6e6;
      }
      .btn-dropdown:active {
        box-shadow: inset 0 3px 5px rgba(0,0,0,.125);
        color: #333;
        background-color: #e6e6e6;
      }
      /* legend */
      .legend {
        color: #555;
        z-index: 900;
        opacity: 1 !important;
      }
      .legend i {
        width: 18px;
        height: 18px;
        float: left;
        margin-right: 8px;
        opacity: 1 !important;
      }
      .info {
        padding: 6px 8px;
        font: 14px/16px Arial, Helvetica, sans-serif;
        background: white;
        background: rgba(255,255,255,1);
        box-shadow: 0 0 15px rgba(0,0,0,0.2);
        border-radius: 5px;
        opacity: 1 !important;
        z-index: 900;
      }
      .info h4 {
        margin: 0 0 5px;
        color: #777;
        opacity: 1 !important;
      }
      .fa-angle-down:hover {
        color: #000000 !important;
      }
      #legend-button {
        width: 120px;
        font-size: 16px;
        padding: 6px;
        margin-bottom: 0;
        color: #333;
        background-color: #fff;
        border: 0px;
        border-radius: 3px;
        box-shadow: 0px 0px 0px 2px rgba(0,0,0,0.3);
        white-space: nowrap;
        z-index: 100000;
      }
      #legend-button:hover {
        color: #333;
        background-color: #e6e6e6;
      }
      #legend-button:active:focus {
          outline: thin dotted;
          outline: 5px auto -webkit-focus-ring-color;
          outline-offset: -2px;
      }
      #legend-button:focus {
        color: #333;
        background-color: #e6e6e6;
      }
      #legend-button:active {
        box-shadow: inset 0 3px 5px rgba(0,0,0,.125);
        color: #333;
        background-color: #e6e6e6;
      }
      /* popup */
      #popup-table {
        font: sans-serif;
        border-collapse: collapse;
        font-size: 12px;
        border-radius: 5px 5px 0 0;
        max-height: 200px;
        overflow-y: scroll;
        display: block;
      }
      #popup-table thead tr {
        background-color: #ffffff;
        color: #015ba0;
        font-size: 13px;
        text-align: left;
        font-weight: bold;
      }
      #popup-table th,
      #popup-table td {
        padding: 12px 15px;
      }
      #popup-table tbody tr {
        border-top: 1px solid #dddddd;
      }
      #popup-table tbody tr.active-row {
        font-weight: bold;
        color: #009879;
      }
      #popup-table tbody tr[aria-expanded=true] .fa-plus {
         display: none;
      }
      #popup-table tbody tr[aria-expanded=false] .fa-minus {
         display: none;
      }
      .fa-angle-left:hover {
        color: #000000 !important;
      }
      #go_back_button:hover {
        color: #000000 !important;
      }
      /* tooltip for "Percentile" in popup */
      #percentile_info:hover:after {
        content: "Every indicator is ranked as a percentile from 0 to 100, indicating the value below which a given percentage of observations fall. For example, if a census tract has a final percentile of 75, that means 75% of census tracts are experiencing an equal or lesser amount of environmental injustice than the census tract at which you are looking.";
        font-family: arial;
        display: block;
        z-index: 1;
        position: absolute;
        bottom: 50%;
        right:3%;
        background-color: #ffffff;
        color: #000000;
        width: 200px;
        text-align: center;
        border-radius: 6px;
        box-shadow: 0px 0px 0px 2px rgba(0,0,0,0.3);
        padding: 12px 15px;
      }
      /* tooltip for null final percentiles in popup */
      #final_rank_null_info:hover:after {
        content: "Final percentile is not available due to missing data for 4 or more indicators.";
        font-family: arial;
        display: block;
        z-index: 1;
        position: absolute;
        bottom: 50%;
        right:3%;
        background-color: #ffffff;
        color: #000000;
        width: 200px;
        text-align: center;
        border-radius: 6px;
        box-shadow: 0px 0px 0px 2px rgba(0,0,0,0.3);
        padding: 12px 15px;
      }
      /* info tag */
      #info_tag {
        position: absolute;
        top: 10px;
        left: 60px;
        z-index: 100000000;
        background: #cde5ff;
        box-shadow: 0 0 15px rgba(0,0,0,0.2);
        border-radius: 5px;
        padding: 0.3em 0.5em;
      }
      .fa-close:hover {
        color: #1a5493 !important;
        cursor: pointer;
      }
      /* specific to tablet and mobile screens */
      @media screen and (max-width: 681.2px) {
        /* re-position legend collapse button */
        .down-arrow {
          position: absolute;
          right:18px;
          bottom:425px !important;
        }
        /* re-position info tag */
        #info_tag {
          position: absolute;
          left: 10px !important;
        }
      }
    </style>
  </head>

  <body>

    <div id="map"></div>

    <!-- dropdown selector-->
    <div id="wrapper-dropdown-selector">
      <!-- using bootstrap select to style https://developer.snapappointments.com/bootstrap-select/examples/ -->
      <select id="js-dropdown-selector" class="selectpicker" data-style="btn-dropdown" data-width="250px" style="z-index: 999999 !important;">
      </select>
    </div>

    <!-- info tag on load -->
    <div id="info_tag">
      <h5 style="color: #004086;"><i class="fa fa-info-circle fa-xs" aria-hidden="true"></i>  Click on a census tract for more information.&nbsp;&nbsp;<i class="fa fa-close" style="color: #648cbd;"></i></h5>
    </div>

    <!-- toggle legend buttons-->
    <i class="fa fa-angle-down fa-2x down-arrow" aria-hidden="true" style="color:#949494; position: absolute; right:18px; bottom:410px; z-index: 100000 !important;"></i>
    <button id="legend-button" class="btn2" style="position: absolute; right:8px; bottom:20px; z-index: 100000 !important;">Show legend</button>

    <script>

      var lat = 39.019715;
      var lng = -105.085529;
      var zoom = 7;
      //setView to focus on CO, set maxZoom and minZoom to restrict zoom out beyond CO and zoom in to the point where all labels disappear
      const map = L.map('map', {zoomControl: false, minZoom:6, maxZoom:15}).setView([lat, lng], zoom);

      //basemap
      L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}.png').addTo(map);

      //add label layer
      L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/terrain-labels/{z}/{x}/{y}{r}.{ext}', {
        attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        subdomains: 'abcd',
        zIndex: 10,
        ext: 'png'
      }).addTo(map);

      const client = new carto.Client({
        apiKey: 'default_public',
        username: 'tiffanyhuynh'
      });

      // synced with dataset uploaded to Carto, "colorado_final" set to public view
      const source = new carto.source.Dataset('colorado_final');

      // onload map coloring: finalscore
      // color using Turbo-Carto CSS https://carto.com/developers/styling/turbocarto/
      // set null value tracts to light gray
      const layerStyle = new carto.style.CartoCSS(`
        #layer {
          polygon-fill: ramp([finalscore], (#409493,#68a7ad,#8bb9c3,#aacad6,#c7dbe4,#f0d6c6,#ebc4ab,#e4b08d,#db996b,#cf8146), quantiles(10));
            ::outline {
              line-width: 0.5;
              line-color: #CCCCCC;
              line-opacity: 0.5;
            }
          [finalscore=null] {
            polygon-fill: #d3d3d3;
          }
        }
      `);

      const layer = new carto.layer.Layer(source, layerStyle, {
        //columns needed in popup
        featureOverColumns: ['cartodb_id', 'name',
         'fips_tract',
         'lead_rank',
         'total_pop',
         'pop_densit',
         'poverty_ra',
         'edu_rank',
         'lin_rank',
         'unemploy_r',
         'nonwhite_r',
         'housebur_1',
         'ozone_rank',
         'diesel_ran',
         'oil_score',
         'oil_densit',
         'toxics_ran',
         'pm25_rank',
         'ptraf_rank',
         'ptsdf_rank',
         'prmp_rank',
         'pwdis_rank',
         'pnpl_rank',
         'asthma_ran',
         'lb_rank',
         'hd_rank',
         'demographi',
         'exposure_s',
         'effects_sc',
         'sensitive_',
         'pollution_',
         'pop_char',
         'final_rank']
      });

      client.addLayer(layer);
      client.getLeafletLayer().addTo(map);

/////////////////////////// dictionary + JSON objects for indicators data ///////////////////////////////

      //form: dictionary =
        // key as rank column title,
        // value as JSON object with the categories: official display name, column rank, column score, parent indicator (pop_char or pollution_), choropleth colors, number of quantiles for ramp, and indicator descriptions for the popup
      //order of entries = order of content in popup for now
      //also: Carto automatically truncates column names to 10 letters or less...
      ind_dict = {'final_rank': {"indicator_name" : "Final Percentile", "indicator_score" : "finalscore", "parent": "", "choropleth_colors":['#409493','#68a7ad','#8bb9c3','#aacad6','#c7dbe4','#f0d6c6','#ebc4ab','#e4b08d','#db996b','#cf8146'], "num_quantiles": 10,
          "description": ""},
      'pop_densit': {"indicator_name" : "Population Density", "indicator_score" : "pop_densit", "parent": "", "choropleth_colors":["#edf8e9","#d4eece","#bae4b4","#a1d99b","#83cb82","#64bc6e","#41ab5d","#2e964d","#187a3f","#005a32"], "num_quantiles": 10,
          "description": ""},
      'pop_char': {"indicator_name" : "Population Characteristics", "indicator_score" : "pop_char", "parent": "", "choropleth_colors":["#f6eff7","#dddbec","#c2cae2","#a6bddb","#7eb0d3","#59a1ca","#3690c0","#1c869c","#057776","#016450"], "num_quantiles": 10,
          "description": ""},
      // 'demographi': {"indicator_name" : "Socioeconomic Factors", "indicator_score" : "demographi", "parent": "", "choropleth_colors":["#f0f9e8","#d8f0d1","#c0e6c0","#a8ddb5","#8bd2bf","#6ec4c9","#4eb3d3","#3899c5","#237ab3","#08589e"], "num_quantiles": 10},
      'nonwhite_r': {"indicator_name" : "People of Color", "indicator_score" : "nonwhitepe", "parent": "pop_char", "choropleth_colors":["#f6eff7","#dddbec","#c2cae2","#a6bddb","#7eb0d3","#59a1ca","#3690c0","#1c869c","#057776","#016450"], "num_quantiles": 10,
          "description": "The proportion of adults who identify as anything aside from “white only” on the census. People of color are drastically more affected by and exposed to pollution, have higher levels of stress, and are often systematically excluded from healthy housing, quality healthcare, and access to wealth."},
      'poverty_ra': {"indicator_name" : "Poverty", "indicator_score" : "poverty_sc", "parent": "pop_char", "choropleth_colors":["#f6eff7","#dddbec","#c2cae2","#a6bddb","#7eb0d3","#59a1ca","#3690c0","#1c869c","#057776","#016450"], "num_quantiles": 10,
          "description": "The proportion of households with an income below double the Federal poverty line: $52,400 for a family of four. These households have higher stress, less access to healthcare, and are often much more affected by pollution."},
      'edu_rank': {"indicator_name" : "No HS Degree", "indicator_score" : "edu_score", "parent": "pop_char","choropleth_colors":["#f6eff7","#dddbec","#c2cae2","#a6bddb","#7eb0d3","#59a1ca","#3690c0","#1c869c","#057776","#016450"], "num_quantiles": 10,
          "description": "The proportion of the population that is over 25 years old without a high school degree. There are strong links between higher levels of education and resistance to environmental toxic exposure."},
      'lin_rank': {"indicator_name" : "Linguistic Isolation", "indicator_score" : "lin_score", "parent": "pop_char","choropleth_colors":["#f6eff7","#dddbec","#c2cae2","#a6bddb","#7eb0d3","#59a1ca","#3690c0","#1c869c","#057776","#016450"], "num_quantiles": 10,
          "description": "The percentage of households reporting that no-one over the age of 5 speaks English “very well.” These households tend to receive lower-quality medical care, and are often left out of decision-making by their local government."},
      'unemploy_r': {"indicator_name" : "Unemployment", "indicator_score" : "unemploy_s", "parent": "pop_char", "choropleth_colors":["#f6eff7","#dddbec","#c2cae2","#a6bddb","#7eb0d3","#59a1ca","#3690c0","#1c869c","#057776","#016450"], "num_quantiles": 10,
          "description": "The proportion of adults who are unemployed. Unemployed people face high levels of stress, which is closely linked to health outcomes."},
      'housebur_1': {"indicator_name" : "Extreme Housing Burden", "indicator_score" : "houseburde", "parent": "pop_char", "choropleth_colors":["#f6eff7","#dddbec","#c2cae2","#a6bddb","#7eb0d3","#59a1ca","#3690c0","#1c869c","#057776","#016450"], "num_quantiles": 10,
          "description": "The proportion of low-income households that have to spend more than half their income on rent. These households experience higher levels of stress, report lower health, and may delay medical treatment because of its high cost."},
      // 'sensitive_': {"indicator_name" : "Sensitive Populations", "indicator_score" : "sensitive_","choropleth_colors":["#f6eff7","#dddbec","#c2cae2","#a6bddb","#7eb0d3","#59a1ca","#3690c0","#1c869c","#057776","#016450"], "num_quantiles": 10},
      'asthma_ran': {"indicator_name" : "Asthma", "indicator_score" : "asthma_sco", "parent": "pop_char", "choropleth_colors":["#f6eff7","#dddbec","#c2cae2","#a6bddb","#7eb0d3","#59a1ca","#3690c0","#1c869c","#057776","#016450"], "num_quantiles": 10,
          "description": "Asthma is a chronic lung disease that causes breathlessness, wheezing, coughing, and chest tightness, which may be caused or made worse by exposure to traffic and outdoor air pollutants. It also makes people much more vulnerable to some forms of pollution."},
      'lb_rank': {"indicator_name" : "Low Birthweight Infants", "indicator_score" : "lb_score", "parent": "pop_char","choropleth_colors":["#f6eff7","#dddbec","#c2cae2","#a6bddb","#7eb0d3","#59a1ca","#3690c0","#1c869c","#057776","#016450"], "num_quantiles": 10,
          "description": "Low birthweight infants are infants born early or underweight, weighing 5 pounds and 8 ounces or less. They have a high risk of infant mortality or of having chronic health conditions later in life that may increase sensitivity to pollution."},
      'hd_rank': {"indicator_name" : "Heart Disease",  "indicator_score" : "hd_score", "parent": "pop_char", "choropleth_colors":["#f6eff7","#dddbec","#c2cae2","#a6bddb","#7eb0d3","#59a1ca","#3690c0","#1c869c","#057776","#016450"], "num_quantiles": 10,
          "description": "Heart disease, specifically coronary heart disease, can partially or completely block blood flow in the large arteries of the heart, causing chest pain or a heart attack. There is strong evidence that air pollution contributes to coronary heart disease and death following a heart attack."},
      'pollution_': {"indicator_name" : "Pollution Burden", "indicator_score" : "pollution_", "parent": "", "choropleth_colors":["#e4f1e1","#c4e1d3","#a6d1c5","#89c0b6","#70afa7","#599d99","#448c8a","#327b7b","#20696d","#0d585f"], "num_quantiles": 10,
          "description": ""},
      // 'exposure_s': {"indicator_name" : "Exposures", "indicator_score" : "exposure_s","choropleth_colors":["#ede5cf","#e5ceb1","#dcb598","#d39c83","#c78376","#b86b6a","#a65461","#8d4158","#722f4c","#541f3f"], "num_quantiles": 10},
      'ozone_rank': {"indicator_name" : "Ozone", "indicator_score" : "ozone_scor", "parent": "pollution_", "choropleth_colors":["#e4f1e1","#c4e1d3","#a6d1c5","#89c0b6","#70afa7","#599d99","#448c8a","#327b7b","#20696d","#0d585f"], "num_quantiles": 10,
          "description": "Ozone is a chemical that combines with other air pollutants to form smog and is a widespread and significant health threat."},
      'diesel_ran': {"indicator_name" : "Diesel PM", "indicator_score" : "diesel_sco", "parent": "pollution_", "choropleth_colors":["#e4f1e1","#c4e1d3","#a6d1c5","#89c0b6","#70afa7","#599d99","#448c8a","#327b7b","#20696d","#0d585f"], "num_quantiles": 10,
          "description": "Diesel particulate matter (Diesel PM) is small particles made by burning diesel. Diesel PM is known to cause eye and throat irritation, along with heart and lung disease and lung cancer. "},
      'lead_rank': {"indicator_name" : "Lead Paint", "indicator_score" : "lead_score", "parent": "pollution_", "choropleth_colors":["#e4f1e1","#c4e1d3","#a6d1c5","#89c0b6","#70afa7","#599d99","#448c8a","#327b7b","#20696d","#0d585f"], "num_quantiles": 10,
          "description": "The proportion of older residences that may have lead-based paint, which can cause developmental delays, seizures, miscarriages, and other serious health problems."},
      'toxics_ran': {"indicator_name" : "Air Toxics", "indicator_score" : "toxics_sco", "parent": "pollution_", "choropleth_colors":["#e4f1e1","#c4e1d3","#a6d1c5","#89c0b6","#70afa7","#599d99","#448c8a","#327b7b","#20696d","#0d585f"], "num_quantiles": 10,
          "description": "Air toxics are hazardous air pollutants from many sources including cars, trucks, and industrial facilities, and may cause cancer or other serious health effects. These include reproductive problems and birth defects."},
      'pm25_rank': {"indicator_name" : "PM2.5", "indicator_score" : "pm25_score", "parent": "pollution_", "choropleth_colors":["#e4f1e1","#c4e1d3","#a6d1c5","#89c0b6","#70afa7","#599d99","#448c8a","#327b7b","#20696d","#0d585f"], "num_quantiles": 10,
          "description": "Particulate Matter 2.5 (PM 2.5) is a mix of particles smaller than 2.5 micrometers in the air produced by cars, trucks, and industries. PM 2.5 is harmful to humans because it can move deep into our lungs and cause irritation, heart and lung disease, or cancer."},
      'ptraf_rank': {"indicator_name" : "Traffic", "indicator_score" : "avg_ptraf", "parent": "pollution_", "choropleth_colors":["#e4f1e1","#c4e1d3","#a6d1c5","#89c0b6","#70afa7","#599d99","#448c8a","#327b7b","#20696d","#0d585f"], "num_quantiles": 10,
          "description": "Traffic is a significant source of air pollution, particularly in urban areas, and has a wide range of negative effects including noise, vibration, injuries, illnesses and diseases due to air pollution. "},
      // 'effects_sc': {"indicator_name" : "Environmental Effects", "indicator_score" : "effects_sc","choropleth_colors":["#e4f1e1","#c4e1d3","#a6d1c5","#89c0b6","#70afa7","#599d99","#448c8a","#327b7b","#20696d","#0d585f"], "num_quantiles": 10},
      'oil_score': {"indicator_name" : "Oil and Gas", "indicator_score" : "oil_score", "parent": "pollution_", "choropleth_colors":["#e4f1e1","#c4e1d3","#a6d1c5","#89c0b6","#70afa7","#599d99","#448c8a","#327b7b","#20696d","#0d585f"], "num_quantiles": 10,
          "description": "Oil and gas facilities include wells, wastewater pits, and tanks of oil or other dangerous chemicals located near populated areas. Oil and gas operations have been linked to many health problems in nearby communities including headaches, nausea, cancer, asthma, and birth defects."},
      'oil_densit': {"indicator_name" : "Oil Density", "indicator_score" : "oil_densit", "parent": "pollution_", "choropleth_colors":["#e4f1e1","#c4e1d3","#a6d1c5","#89c0b6","#70afa7","#599d99","#448c8a","#327b7b","#20696d","#0d585f"], "num_quantiles": 10,
          "description": ""},
      'ptsdf_rank': {"indicator_name" : "Hazardous Waste Facilities", "indicator_score" : "avg_ptsdf", "parent": "pollution_", "choropleth_colors":["#e4f1e1","#c4e1d3","#a6d1c5","#89c0b6","#70afa7","#599d99","#448c8a","#327b7b","#20696d","#0d585f"], "num_quantiles": 10,
          "description": "Hazardous waste facilities treat, store, or dispose of volatile substances that are dangerous to humans and may reach people through the air or water."},
      'prmp_rank': {"indicator_name" : "High-Risk Chemical Facilities", "indicator_score" : "avg_prmp", "parent": "pollution_", "choropleth_colors":["#e4f1e1","#c4e1d3","#a6d1c5","#89c0b6","#70afa7","#599d99","#448c8a","#327b7b","#20696d","#0d585f"], "num_quantiles": 10,
          "description": "High-risk chemical facilities maintain highly toxic, flammable, or explosive substances that may release acutely toxic substances which can cause serious health effects or death."},
      'pwdis_rank': {"indicator_name" : "Wastewater Releases", "indicator_score" : "avg_pwdis", "parent": "pollution_", "choropleth_colors":["#e4f1e1","#c4e1d3","#a6d1c5","#89c0b6","#70afa7","#599d99","#448c8a","#327b7b","#20696d","#0d585f"], "num_quantiles": 10,
          "description": "Wastewater in streams and other water sources may come from industrial, commercial, or agricultural sources and contain pollutants that can cause water-borne illnesses and diseases."},
      'pnpl_rank': {"indicator_name" : "Federal Cleanup Sites", "indicator_score" : "avg_pnpl", "parent": "pollution_", "choropleth_colors":["#e4f1e1","#c4e1d3","#a6d1c5","#89c0b6","#70afa7","#599d99","#448c8a","#327b7b","#20696d","#0d585f"], "num_quantiles": 10,
          "description": "Federal cleanup sites, or “Superfund sites,” are locations where extremely hazardous chemicals have been dumped or otherwise poorly managed and may reach humans through the air or water, threatening human health."}};

///////////////////////////// closable info tag on load ///////////////////////////

      // to close the info tag
      $(".fa-close").click(function(){
        $("#info_tag").hide();
      });

///////////////////////////// custom zoom bar control that includes a Zoom Home function///////////////////////////

      // from this tutorial: http://jsfiddle.net/pqfche83/1/
      L.Control.zoomHome = L.Control.extend({
          options: {
              position: 'topleft',
              zoomInText: '+',
              zoomInTitle: 'Zoom in',
              zoomOutText: '-',
              zoomOutTitle: 'Zoom out',
              zoomHomeText: '<i class="fa fa-home" style="line-height:1.65;"></i>',
              zoomHomeTitle: 'Zoom home'
          },

          onAdd: function (map) {
              var controlName = 'gin-control-zoom',
                  container = L.DomUtil.create('div', controlName + ' leaflet-bar'),
                  options = this.options;

              this._zoomInButton = this._createButton(options.zoomInText, options.zoomInTitle,
              controlName + '-in', container, this._zoomIn);
              this._zoomHomeButton = this._createButton(options.zoomHomeText, options.zoomHomeTitle,
              controlName + '-home', container, this._zoomHome);
              this._zoomOutButton = this._createButton(options.zoomOutText, options.zoomOutTitle,
              controlName + '-out', container, this._zoomOut);

              this._updateDisabled();
              map.on('zoomend zoomlevelschange', this._updateDisabled, this);

              return container;
          },

          onRemove: function (map) {
              map.off('zoomend zoomlevelschange', this._updateDisabled, this);
          },

          _zoomIn: function (e) {
              this._map.zoomIn(e.shiftKey ? 3 : 1);
          },

          _zoomOut: function (e) {
              this._map.zoomOut(e.shiftKey ? 3 : 1);
          },

          _zoomHome: function (e) {
              map.setView([lat, lng], zoom);
          },

          _createButton: function (html, title, className, container, fn) {
              var link = L.DomUtil.create('a', className, container);
              link.innerHTML = html;
              link.href = '#';
              link.title = title;

              L.DomEvent.on(link, 'mousedown dblclick', L.DomEvent.stopPropagation)
                  .on(link, 'click', L.DomEvent.stop)
                  .on(link, 'click', fn, this)
                  .on(link, 'click', this._refocusOnMap, this);

              return link;
          },

          _updateDisabled: function () {
              var map = this._map,
                  className = 'leaflet-disabled';

              L.DomUtil.removeClass(this._zoomInButton, className);
              L.DomUtil.removeClass(this._zoomOutButton, className);

              if (map._zoom === map.getMinZoom()) {
                  L.DomUtil.addClass(this._zoomOutButton, className);
              }
              if (map._zoom === map.getMaxZoom()) {
                  L.DomUtil.addClass(this._zoomInButton, className);
              }
          }
      });
      // add the new control to the map
      var zoomHome = new L.Control.zoomHome();
      zoomHome.addTo(map);

////////////////////////////////////////// Geocoder //////////////////////////////////////////////

      // Geocoder: plugin from https://github.com/perliedman/leaflet-control-geocoder
      // got rid of marker and instead just zooms to the returned bounding box
      var geocoder = L.Control.geocoder({
        defaultMarkGeocode: false,
        position: 'topleft'
      })
        .on('markgeocode', function(e) {
          var bbox = e.geocode.bbox;
          var poly = L.polygon([
            bbox.getSouthEast(),
            bbox.getNorthEast(),
            bbox.getNorthWest(),
            bbox.getSouthWest()
          ]);
          map.fitBounds(poly.getBounds());
        })
        .addTo(map);

/////////////////////////// highlight tract borders when click ///////////////////////////////


      var polygon;
      function showFeature(featureEvent) {

        //get cartodb_id from clicking the map
        new_polygon_selected = featureEvent.data.cartodb_id;

        if (!map.hasLayer(polygon)) {

          // using Carto SQl API: https://carto.com/developers/sql-api/guides/making-calls/
          // get polygon boundary info of census tract clicked through PostGIS query
          const boundsQuery = `SELECT ST_asGeoJSON(ST_Boundary(the_geom)) as geom FROM colorado_final WHERE cartodb_id = ${new_polygon_selected}`;
          const boundsUrl = `https://tiffanyhuynh.carto.com/api/v2/sql?q=${boundsQuery}&api_key=default_public`

          //https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch
          //https://www.javascripttutorial.net/es6/promise-chaining/
          fetch(boundsUrl)
            .then(response => {
                return response.json();
              })
              .then(json => {
                polygon = L.geoJson(JSON.parse(json.rows[0].geom), {
                  style: {
                    color: "#15F4EE",
                    fillColor: "#15F4EE",
                    weight: 3,
                    opacity: 0.65
                  }
                })
              map.addLayer(polygon);
              });
        };
      };

      //on click
      layer.on('featureClicked', showFeature);
      // highlight layer is then removed upon popup closing in the popup code section


/////////////////////////// populate dropdown using JSON data ///////////////////////////////

      // using HTML DOM innerHTML to dynamically update the values of bootstrap select, written above
      // https://www.w3schools.com/jsref/prop_html_innerhtml.asp
      window.onload = function() {
        var dropdown_html;
        for (var key in ind_dict) {
          var get_value = ind_dict[key]; //JSON object for that key
          if (key == "final_rank") {
            //code apart from others because want this to be default selected
            dropdown_html += `<option value="final_rank" style="font-weight:bold !important;" selected>Final Percentile</option>`;
          } else if (get_value.parent == "") {  //if parent indicator bold and don't indent
            dropdown_html += `<option value="${key}" style="font-weight:bold !important;">${get_value.indicator_name}</option>`;
          } else { //else indent for childen indicators
              dropdown_html += `<option value="${key}">&nbsp;&nbsp;&nbsp;${get_value.indicator_name}</option>`;
          }
        }
        document.getElementById("js-dropdown-selector").innerHTML = dropdown_html;
        $('.selectpicker').selectpicker('refresh');
      };

/////////////////////////// change layers on dropdown select using JSON data ////////////////////////

      //change map coloring with change in dropdown value selected
      $("#js-dropdown-selector").on('change', function(e) {
        let value = e.target.value; //value picked from dropdown
        var returned_value = ind_dict[value];
        layerStyle.setContent(`
          #layer {
            polygon-fill: ramp([${returned_value.indicator_score}], (${returned_value.choropleth_colors}), quantiles(${returned_value.num_quantiles}));
              ::outline {
                line-width: 0.5;
                line-color: #CCCCCC;
                line-opacity: 0.5;
              }
            [${returned_value.indicator_score}=null] {
              polygon-fill: #d3d3d3;
            }
          }`)
         .then(() => {
           console.log('cartoCSS was updated');
         })
         .catch(() => {
           console.error('Error updating the cartoCSS for the layer');
         });
      });

/////////////////////////// popups using indicator JSON ///////////////////////////////

    // create popup
    const popup = L.popup({closeButton: true, maxHeight: 280, maxWidth: 400});

    // set corresponding popup content
    function openPopup(featureEvent) {

      //"first page" content
      let content = '<div id="first_page_popup">';

      //FIPS tract id title
      content += `<h4 class="open-sans" style="line-height: 200%; color:#015ba0;">Census tract: ${featureEvent.data.fips_tract}</h4>`;

      //final rank
      if (featureEvent.data['final_rank'] == null) {
        content += `<h5 class="open-sans">Final Percentile: N/A  <i class="fa fa-info-circle fa-xs" id="final_rank_null_info" aria-hidden="true"></i></h5>`;
      } else {
        content += `<h5 class="open-sans">Final Percentile: ${featureEvent.data.final_rank.toFixed(2)}</h5>`;
      }

      //total pop
      if (featureEvent.data['total_pop'] == null) {
        content += `<h5 class="open-sans">Total Population: N/A</h5></br>`;
      } else {
        content += `<h5 class="open-sans">Total Population: ${featureEvent.data.total_pop.toFixed(0)}</h5></br>`;
      }

      // start table
      // using HTML tables: https://www.w3schools.com/html/html_tables.asp
      // making table responsive with Bootstrap collapse: https://getbootstrap.com/docs/4.0/components/collapse/
      // tutorial: https://stackoverflow.com/questions/52737398/how-do-i-do-a-bootstrap-responsive-table-inside-another-table
      content += '<table id="popup-table" class="table table-responsive table-hover">';

      //table head
      content += '<thead><tr><th>Indicators</th><th>Percentile <i class="fa fa-info-circle fa-xs" id="percentile_info" aria-hidden="true"></i></th></tr></thead>';

      //table parent entry: population characteristics
      content += '<tbody><tr class="clickable" data-toggle="collapse" data-target="#group-of-rows-1" aria-expanded="false" aria-controls="group-of-rows-1">';
      content += '<td style="padding-left:-5px; cursor:pointer;"><i class="fa fa-plus" aria-hidden="true"></i><i class="fa fa-minus" aria-hidden="true"></i>&nbsp;&nbsp;&nbsp;<b>Population Characteristics</b></td>';
      if (featureEvent.data['pop_char'] == null) {
        content += '<td><b>N/A</b></td>';
      } else {
        content += `<td><b>${featureEvent.data.pop_char.toFixed(2)}</b></td>`;
      }
      content += '</tr></tbody>';

      //table child entries: of population characteristics
      content += '<tbody id="group-of-rows-1" class="collapse">';
      for (var key in ind_dict) {
        if (ind_dict[key].parent == "pop_char") {
          var percentile_display;
          if (featureEvent.data[key] == null) {
            percentile_display= "N/A";
          } else {
            percentile_display=featureEvent.data[key].toFixed(2);
          }
          // using HTML dataset https://developer.mozilla.org/en-US/docs/Web/API/HTMLOrForeignElement/dataset
          // save each rows' indicator rank col name (key) in data-key and its percentile in data-percentile for this tract within row entry html to use for its corres. "2nd page" of popup when clicked
          content += `<tr data-key=${key} data-percentile=${percentile_display} style="cursor:pointer;">`;
            var get_data = ind_dict[key];
            content += `<td>&nbsp;&nbsp;&nbsp;${get_data.indicator_name}</td>`; //indented
            if (featureEvent.data[key] == null) {
              content += '<td>N/A <i class="fa fa-angle-right" aria-hidden="true" style="vertical-align:middle; float:right; padding-left:2em;"></i></td>';
            } else {
              content += `<td>${featureEvent.data[key].toFixed(2)}<i class="fa fa-angle-right" aria-hidden="true" style="vertical-align:middle; float:right; padding-left:2em;"></i></td>`;
            }
            content += '</tr>';
        }
      }
      content += '</tbody>';

      //table parent entry: pollution burden
      content += '<tbody><tr class="clickable" data-toggle="collapse" data-target="#group-of-rows-2" aria-expanded="false" aria-controls="group-of-rows-2">';
      content += '<td style="padding-left:-5px; cursor:pointer;"><i class="fa fa-plus" aria-hidden="true"></i><i class="fa fa-minus" aria-hidden="true"></i>&nbsp;&nbsp;&nbsp;<b>Pollution Burden</b></td>';
      if (featureEvent.data['pollution_'] == null) {
        content += '<td><b>N/A</b></td>';
      } else {
        content += `<td><b>${featureEvent.data.pollution_.toFixed(2)}</b></td>`;
      }
      content += '</tr></tbody>';

      //table child entries: of pollution burden
      content += '<tbody id="group-of-rows-2" class="collapse">';
      for (var key in ind_dict) {
        if (ind_dict[key].parent == "pollution_") {
          var percentile_display;
          if (featureEvent.data[key] == null) {
            percentile_display= "N/A";
          } else {
            percentile_display=featureEvent.data[key].toFixed(2);
          }
          content += `<tr data-key=${key} data-percentile=${percentile_display} style="cursor:pointer;">`;
            var get_data = ind_dict[key];
            content += `<td>&nbsp;&nbsp;&nbsp;${get_data.indicator_name}</td>`;
            if (featureEvent.data[key] == null) {
              content += '<td>N/A <i class="fa fa-angle-right" aria-hidden="true" style="vertical-align:middle; float:right; padding-left:2em;"></i></td>';
            } else {
              content += `<td>${featureEvent.data[key].toFixed(2)}<i class="fa fa-angle-right" aria-hidden="true" style="vertical-align:middle; float:right; padding-left:2em;"></i></td>`;
            }
            content += '</tr>';
        }
      }
      content += '</tbody>';

      content += '</table>';
      content += '</div>';

      // "second page" of popup
      content += '<div id="second_page_popup">';
      content += `<h5 class="open-sans" id="go_back_button" style="color: #949494; cursor: pointer;"><i class="fa fa-angle-left" aria-hidden="true"></i>  Back</h5>`;
      content += '<div id="indicator_specific_description"></div>';
      content += '</div>';


      popup.setContent(content);
      popup.setLatLng(featureEvent.latLng);
      if (!popup.isOpen()) {
        popup.openOn(map);
      }
    }

    // open popup on click
    layer.off('featureOut');
    layer.on('featureClicked', openPopup);

    // on popup open, hide the "second page" content from view
    map.on('popupopen', function(e) {
      $("#second_page_popup").hide();
    });

    //removes border highlight from click after user closes corres. popup
    map.on('popupclose', function(e) {
      map.removeLayer(polygon);
    });

    // custom "second page" content shown for each popup depending on what row/indicator is selected within "first page" table
    // tutorial: https://www.youtube.com/watch?v=6BdKUO2QbA0
    // using HTML dataset https://developer.mozilla.org/en-US/docs/Web/API/HTMLOrForeignElement/dataset
    $(document).ready(function() {
      $(document.body).on("click", "tr[data-key]", function () { //once a table row is clicked:
        $("#first_page_popup").hide();
        // set innerHTML of the indicator_specific_description on the "second page" of popup corres. to row clicked
        // using data-key saved in row to retrieve corres. indicator display name and indicator description from JSON dictionary
        // using data-percentile in explanation
        if (this.dataset.percentile == "N/A") {
          document.getElementById("indicator_specific_description").innerHTML =
            `<span><h4 class="open-sans" style="line-height: 150%; color:#015ba0;">${ind_dict[this.dataset.key].indicator_name}</h4></span><span style="display:block;"><p>${ind_dict[this.dataset.key].description}</p>

            <p>This indicator percentile for this census tract is not available due to missing data.</p>

            <a target="_blank" href="https://mappingforej.berkeley.edu/about-our-map/">More info</a>
            </span>`;
        } else {
            document.getElementById("indicator_specific_description").innerHTML =
              `<span><h4 class="open-sans" style="line-height: 150%; color:#015ba0;">${ind_dict[this.dataset.key].indicator_name}</h4></span><span style="display:block;"><p>${ind_dict[this.dataset.key].description}</p>

              <p>The ${ind_dict[this.dataset.key].indicator_name} indicator percentile for this census tract is ${this.dataset.percentile}, meaning it is higher than ${this.dataset.percentile}% of the census tracts in Colorado.</p>

              <a target="_blank" href="https://mappingforej.berkeley.edu/about-our-map/">More info</a>
              </span>`;
        }

        $("#second_page_popup").show();
        $("#go_back_button").click(function(){
          $("#second_page_popup").hide();
          $("#first_page_popup").show();
        });
      });
    });


///////////////////////////// add/change legend ///////////////////////////////

      // will probably redesign this code:

      // make legend a Leaflet Control to control positioning
      // https://leafletjs.com/reference-1.6.0.html#control
      var legend  = L.control({position: 'bottomright'})

      layer.on('metadataChanged', function(event){

        // get buckets/quantiles and their colors from map coloring set by TurboCarto
        var buckets = event.styles[0]._buckets;
        //each Bucket has props: min (min value of the quantile), max (max value of quantile), and value (which here is the color/hex code of the quantile)

        legend.onAdd = function (map) {
          var div = L.DomUtil.create('div', 'info legend'); // create div with classes info and legend

          var column = event.styles[0]._column; // indicator key
          var max_buckets = buckets.length - 1; //num quantiles

          div.innerHTML += '<h5 class="open-sans">Highest</br>Percentiles</h5>';
          for (var i = max_buckets; i >= 0; i--) { //from highest percentiles to lowest
            div.innerHTML +=
              `<ul style="list-style-type:none; padding-left:0"><i style="background: ${buckets[i].value}"></i> <span>${i*10} - ${(i+1)*10}</span></ul>`;
          }
          div.innerHTML += '<h5 class="open-sans" style="padding-bottom:5px;">Lowest</br>Percentiles</h5>';

          // gray for null tracts
          div.innerHTML +=  `<ul style="list-style-type:none; padding-left:0"><i style="background: #d3d3d3"></i> <span style="display:block;">Missing</span><span style="display:block;">data</span></ul>`;

          return div;
        };
        legend.addTo(map);
      });

///////////////////////////// animate legend to collapse and expand ///////////////////////////////

      // if different indicator selected from dropdown, legend will expand if originally collapsed
      layer.on('metadataChanged', function(event){
          $(".legend").show();
          $(".btn2").hide();
          $(".fa-angle-down").show();
      });

      $(document).ready(function(){
        $(".btn2").hide();
        $(".fa-angle-down").click(function(){
          $(".legend").hide();
          $(".fa-angle-down").hide();
          $(".btn2").show();
        });
        $(".btn2").click(function(){
          $(".legend").show();
          $(".btn2").hide();
          $(".fa-angle-down").show();
        });
      });

  </script>
  </body>
</html>
